<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>mod/quiz/yui/src/autosave/js/autosave.js - Moodle</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Moodle"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.7dev (Build: 20140320)</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Bootstrap.Collapse.html">Bootstrap.Collapse</a></li>
            
                <li><a href="../classes/Bootstrap.Dropdown.html">Bootstrap.Dropdown</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotation.html">M.assignfeedback_editpdf.annotation</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationhighlight.html">M.assignfeedback_editpdf.annotationhighlight</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationline.html">M.assignfeedback_editpdf.annotationline</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationoval.html">M.assignfeedback_editpdf.annotationoval</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationpen.html">M.assignfeedback_editpdf.annotationpen</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationrectangle.html">M.assignfeedback_editpdf.annotationrectangle</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationstamp.html">M.assignfeedback_editpdf.annotationstamp</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.colourpicker.html">M.assignfeedback_editpdf.colourpicker</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.comment.html">M.assignfeedback_editpdf.comment</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.commentmenu.html">M.assignfeedback_editpdf.commentmenu</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.commentsearch.html">M.assignfeedback_editpdf.commentsearch</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.drawable.html">M.assignfeedback_editpdf.drawable</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.dropdown.html">M.assignfeedback_editpdf.dropdown</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.edit.html">M.assignfeedback_editpdf.edit</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.editor.html">M.assignfeedback_editpdf.editor</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.point.html">M.assignfeedback_editpdf.point</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.quickcomment.html">M.assignfeedback_editpdf.quickcomment</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.quickcommentlist.html">M.assignfeedback_editpdf.quickcommentlist</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.rect.html">M.assignfeedback_editpdf.rect</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.stamppicker.html">M.assignfeedback_editpdf.stamppicker</a></li>
            
                <li><a href="../classes/M.atto_accessibilitychecker.Button.html">M.atto_accessibilitychecker.Button</a></li>
            
                <li><a href="../classes/M.atto_accessibilityhelper.Button.html">M.atto_accessibilityhelper.Button</a></li>
            
                <li><a href="../classes/M.atto_align.button.html">M.atto_align.button</a></li>
            
                <li><a href="../classes/M.atto_backcolor.button.html">M.atto_backcolor.button</a></li>
            
                <li><a href="../classes/M.atto_bold.button.html">M.atto_bold.button</a></li>
            
                <li><a href="../classes/M.atto_charmap.button.html">M.atto_charmap.button</a></li>
            
                <li><a href="../classes/M.atto_clear.button.html">M.atto_clear.button</a></li>
            
                <li><a href="../classes/M.atto_collapse.button.html">M.atto_collapse.button</a></li>
            
                <li><a href="../classes/M.atto_emoticon.button.html">M.atto_emoticon.button</a></li>
            
                <li><a href="../classes/M.atto_equation.Button.html">M.atto_equation.Button</a></li>
            
                <li><a href="../classes/M.atto_fontcolor.button.html">M.atto_fontcolor.button</a></li>
            
                <li><a href="../classes/M.atto_html.button.html">M.atto_html.button</a></li>
            
                <li><a href="../classes/M.atto_image.Button.html">M.atto_image.Button</a></li>
            
                <li><a href="../classes/M.atto_indent.button.html">M.atto_indent.button</a></li>
            
                <li><a href="../classes/M.atto_italic.button.html">M.atto_italic.button</a></li>
            
                <li><a href="../classes/M.atto_link.button.html">M.atto_link.button</a></li>
            
                <li><a href="../classes/M.atto_managefiles.usedfiles.html">M.atto_managefiles.usedfiles</a></li>
            
                <li><a href="../classes/M.atto_media.Button.html">M.atto_media.Button</a></li>
            
                <li><a href="../classes/M.atto_noautolink.button.html">M.atto_noautolink.button</a></li>
            
                <li><a href="../classes/M.atto_orderedlist.button.html">M.atto_orderedlist.button</a></li>
            
                <li><a href="../classes/M.atto_rtl.button.html">M.atto_rtl.button</a></li>
            
                <li><a href="../classes/M.atto_strike.button.html">M.atto_strike.button</a></li>
            
                <li><a href="../classes/M.atto_subscript.button.html">M.atto_subscript.button</a></li>
            
                <li><a href="../classes/M.atto_superscript.button.html">M.atto_superscript.button</a></li>
            
                <li><a href="../classes/M.atto_table.Button.html">M.atto_table.Button</a></li>
            
                <li><a href="../classes/M.atto_title.button.html">M.atto_title.button</a></li>
            
                <li><a href="../classes/M.atto_underline.button.html">M.atto_underline.button</a></li>
            
                <li><a href="../classes/M.atto_undo.button.html">M.atto_undo.button</a></li>
            
                <li><a href="../classes/M.atto_unlink.button.html">M.atto_unlink.button</a></li>
            
                <li><a href="../classes/M.atto_unorderedlist.button.html">M.atto_unorderedlist.button</a></li>
            
                <li><a href="../classes/M.block_navigation.html">M.block_navigation</a></li>
            
                <li><a href="../classes/M.block_navigation.ActionKey.html">M.block_navigation.ActionKey</a></li>
            
                <li><a href="../classes/M.block_navigation.Branch.html">M.block_navigation.Branch</a></li>
            
                <li><a href="../classes/M.block_navigation.Tree.html">M.block_navigation.Tree</a></li>
            
                <li><a href="../classes/M.core.actionmenu.ActionMenu.html">M.core.actionmenu.ActionMenu</a></li>
            
                <li><a href="../classes/M.core.ajaxException.html">M.core.ajaxException</a></li>
            
                <li><a href="../classes/M.core.alert.html">M.core.alert</a></li>
            
                <li><a href="../classes/M.core.blockdraganddrop.BlockRegion.html">M.core.blockdraganddrop.BlockRegion</a></li>
            
                <li><a href="../classes/M.core.blockdraganddrop.LegacyManager.html">M.core.blockdraganddrop.LegacyManager</a></li>
            
                <li><a href="../classes/M.core.blockdraganddrop.Manager.html">M.core.blockdraganddrop.Manager</a></li>
            
                <li><a href="../classes/M.core.chooserdialogue.html">M.core.chooserdialogue</a></li>
            
                <li><a href="../classes/M.core.confirm.html">M.core.confirm</a></li>
            
                <li><a href="../classes/M.core.dialogue.html">M.core.dialogue</a></li>
            
                <li><a href="../classes/M.core.dock.ActionKey.html">M.core.dock.ActionKey</a></li>
            
                <li><a href="../classes/M.core.dock.Block.html">M.core.dock.Block</a></li>
            
                <li><a href="../classes/M.core.dock.Dock.html">M.core.dock.Dock</a></li>
            
                <li><a href="../classes/M.core.dock.DockedItem.html">M.core.dock.DockedItem</a></li>
            
                <li><a href="../classes/M.core.dock.Loader.html">M.core.dock.Loader</a></li>
            
                <li><a href="../classes/M.core.dock.Panel.html">M.core.dock.Panel</a></li>
            
                <li><a href="../classes/M.core.dock.TabHeightManager.html">M.core.dock.TabHeightManager</a></li>
            
                <li><a href="../classes/M.core.dragdrop.html">M.core.dragdrop</a></li>
            
                <li><a href="../classes/M.core.exception.html">M.core.exception</a></li>
            
                <li><a href="../classes/M.core.formchangechecker.html">M.core.formchangechecker</a></li>
            
                <li><a href="../classes/M.core.LockScroll.html">M.core.LockScroll</a></li>
            
                <li><a href="../classes/M.core.notification.html">M.core.notification</a></li>
            
                <li><a href="../classes/M.core.notification.info.html">M.core.notification.info</a></li>
            
                <li><a href="../classes/M.core.popuphelp.html">M.core.popuphelp</a></li>
            
                <li><a href="../classes/M.core.tooltip.html">M.core.tooltip</a></li>
            
                <li><a href="../classes/M.core.WidgetFocusAfterHide.html">M.core.WidgetFocusAfterHide</a></li>
            
                <li><a href="../classes/M.core_backup.backupselectall.html">M.core_backup.backupselectall</a></li>
            
                <li><a href="../classes/M.core_backup.confirmcancel.html">M.core_backup.confirmcancel</a></li>
            
                <li><a href="../classes/M.course.coursebase.html">M.course.coursebase</a></li>
            
                <li><a href="../classes/M.course.dragdrop.resource.html">M.course.dragdrop.resource</a></li>
            
                <li><a href="../classes/M.course.dragdrop.section.html">M.course.dragdrop.section</a></li>
            
                <li><a href="../classes/M.course.management.Category.html">M.course.management.Category</a></li>
            
                <li><a href="../classes/M.course.management.Console.html">M.course.management.Console</a></li>
            
                <li><a href="../classes/M.course.management.Course.html">M.course.management.Course</a></li>
            
                <li><a href="../classes/M.course.management.DragDrop.html">M.course.management.DragDrop</a></li>
            
                <li><a href="../classes/M.course.management.Item.html">M.course.management.Item</a></li>
            
                <li><a href="../classes/M.course.modchooser.html">M.course.modchooser</a></li>
            
                <li><a href="../classes/M.course.toolboxes.resources.html">M.course.toolboxes.resources</a></li>
            
                <li><a href="../classes/M.course.toolboxes.section.html">M.course.toolboxes.section</a></li>
            
                <li><a href="../classes/M.course.toolboxes.toolbox.html">M.course.toolboxes.toolbox</a></li>
            
                <li><a href="../classes/M.editor_atto.Editor.html">M.editor_atto.Editor</a></li>
            
                <li><a href="../classes/M.editor_atto.EditorClean.html">M.editor_atto.EditorClean</a></li>
            
                <li><a href="../classes/M.editor_atto.EditorFilepicker.html">M.editor_atto.EditorFilepicker</a></li>
            
                <li><a href="../classes/M.editor_atto.EditorPlugin.html">M.editor_atto.EditorPlugin</a></li>
            
                <li><a href="../classes/M.editor_atto.EditorPluginButtons.html">M.editor_atto.EditorPluginButtons</a></li>
            
                <li><a href="../classes/M.editor_atto.EditorPluginDialogue.html">M.editor_atto.EditorPluginDialogue</a></li>
            
                <li><a href="../classes/M.editor_atto.EditorSelection.html">M.editor_atto.EditorSelection</a></li>
            
                <li><a href="../classes/M.editor_atto.EditorStyling.html">M.editor_atto.EditorStyling</a></li>
            
                <li><a href="../classes/M.editor_atto.EditorTextArea.html">M.editor_atto.EditorTextArea</a></li>
            
                <li><a href="../classes/M.editor_atto.EditorToolbar.html">M.editor_atto.EditorToolbar</a></li>
            
                <li><a href="../classes/M.editor_atto.EditorToolbarNav.html">M.editor_atto.EditorToolbarNav</a></li>
            
                <li><a href="../classes/M.editor_atto.Menu.html">M.editor_atto.Menu</a></li>
            
                <li><a href="../classes/M.form.shortforms.html">M.form.shortforms</a></li>
            
                <li><a href="../classes/M.form.showadvanced.html">M.form.showadvanced</a></li>
            
                <li><a href="../classes/M.mod_quiz.autosave.html">M.mod_quiz.autosave</a></li>
            
                <li><a href="../classes/M.tool_capability.Search.html">M.tool_capability.Search</a></li>
            
                <li><a href="../classes/Moodle.core_course.util.html">Moodle.core_course.util</a></li>
            
                <li><a href="../classes/Moodle.core_course.util.cm.html">Moodle.core_course.util.cm</a></li>
            
                <li><a href="../classes/Moodle.core_course.util.section.html">Moodle.core_course.util.section</a></li>
            
                <li><a href="../classes/Moodle.theme_bootstrapbase.bootstrap.html">Moodle.theme_bootstrapbase.bootstrap</a></li>
            
                <li><a href="../classes/Y.BootstrapEngine.html">Y.BootstrapEngine</a></li>
            
                <li><a href="../classes/Y.Moodle.course.categoryexpander.html">Y.Moodle.course.categoryexpander</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/buttons.html">buttons</a></li>
            
                <li><a href="../modules/clean.html">clean</a></li>
            
                <li><a href="../modules/dialogue.html">dialogue</a></li>
            
                <li><a href="../modules/filepicker.html">filepicker</a></li>
            
                <li><a href="../modules/gallery-bootstrap-collapse.html">gallery-bootstrap-collapse</a></li>
            
                <li><a href="../modules/gallery-bootstrap-dropdown.html">gallery-bootstrap-dropdown</a></li>
            
                <li><a href="../modules/gallery-bootstrap-engine.html">gallery-bootstrap-engine</a></li>
            
                <li><a href="../modules/menu-base.html">menu-base</a></li>
            
                <li><a href="../modules/moodle-assignfeedback_editpdf-editor.html">moodle-assignfeedback_editpdf-editor</a></li>
            
                <li><a href="../modules/moodle-atto-managefiles-button.html">moodle-atto-managefiles-button</a></li>
            
                <li><a href="../modules/moodle-atto_accessibilitychecker-button.html">moodle-atto_accessibilitychecker-button</a></li>
            
                <li><a href="../modules/moodle-atto_accessibilityhelper-button.html">moodle-atto_accessibilityhelper-button</a></li>
            
                <li><a href="../modules/moodle-atto_align-button.html">moodle-atto_align-button</a></li>
            
                <li><a href="../modules/moodle-atto_backcolor-button.html">moodle-atto_backcolor-button</a></li>
            
                <li><a href="../modules/moodle-atto_bold-button.html">moodle-atto_bold-button</a></li>
            
                <li><a href="../modules/moodle-atto_charmap-button.html">moodle-atto_charmap-button</a></li>
            
                <li><a href="../modules/moodle-atto_clear-button.html">moodle-atto_clear-button</a></li>
            
                <li><a href="../modules/moodle-atto_collapse-button.html">moodle-atto_collapse-button</a></li>
            
                <li><a href="../modules/moodle-atto_emoticon-button.html">moodle-atto_emoticon-button</a></li>
            
                <li><a href="../modules/moodle-atto_html-button.html">moodle-atto_html-button</a></li>
            
                <li><a href="../modules/moodle-atto_image_alignment-button.html">moodle-atto_image_alignment-button</a></li>
            
                <li><a href="../modules/moodle-atto_indent-button.html">moodle-atto_indent-button</a></li>
            
                <li><a href="../modules/moodle-atto_italic-button.html">moodle-atto_italic-button</a></li>
            
                <li><a href="../modules/moodle-atto_link-button.html">moodle-atto_link-button</a></li>
            
                <li><a href="../modules/moodle-atto_managefiles-usedfiles.html">moodle-atto_managefiles-usedfiles</a></li>
            
                <li><a href="../modules/moodle-atto_media-button.html">moodle-atto_media-button</a></li>
            
                <li><a href="../modules/moodle-atto_noautolink-button.html">moodle-atto_noautolink-button</a></li>
            
                <li><a href="../modules/moodle-atto_orderedlist-button.html">moodle-atto_orderedlist-button</a></li>
            
                <li><a href="../modules/moodle-atto_rtl-button.html">moodle-atto_rtl-button</a></li>
            
                <li><a href="../modules/moodle-atto_strike-button.html">moodle-atto_strike-button</a></li>
            
                <li><a href="../modules/moodle-atto_subscript-button.html">moodle-atto_subscript-button</a></li>
            
                <li><a href="../modules/moodle-atto_superscript-button.html">moodle-atto_superscript-button</a></li>
            
                <li><a href="../modules/moodle-atto_table-button.html">moodle-atto_table-button</a></li>
            
                <li><a href="../modules/moodle-atto_title-button.html">moodle-atto_title-button</a></li>
            
                <li><a href="../modules/moodle-atto_underline-button.html">moodle-atto_underline-button</a></li>
            
                <li><a href="../modules/moodle-atto_undo-button.html">moodle-atto_undo-button</a></li>
            
                <li><a href="../modules/moodle-atto_unlink-button.html">moodle-atto_unlink-button</a></li>
            
                <li><a href="../modules/moodle-atto_unorderedlist-button.html">moodle-atto_unorderedlist-button</a></li>
            
                <li><a href="../modules/moodle-backup-backupselectall.html">moodle-backup-backupselectall</a></li>
            
                <li><a href="../modules/moodle-backup-confirmcancel.html">moodle-backup-confirmcancel</a></li>
            
                <li><a href="../modules/moodle-block_navigation-navigation.html">moodle-block_navigation-navigation</a></li>
            
                <li><a href="../modules/moodle-core-actionmenu.html">moodle-core-actionmenu</a></li>
            
                <li><a href="../modules/moodle-core-blockdraganddrop.html">moodle-core-blockdraganddrop</a></li>
            
                <li><a href="../modules/moodle-core-chooserdialogue.html">moodle-core-chooserdialogue</a></li>
            
                <li><a href="../modules/moodle-core-dock.html">moodle-core-dock</a></li>
            
                <li><a href="../modules/moodle-core-dragdrop.html">moodle-core-dragdrop</a></li>
            
                <li><a href="../modules/moodle-core-formchangechecker.html">moodle-core-formchangechecker</a></li>
            
                <li><a href="../modules/moodle-core-lockscroll.html">moodle-core-lockscroll</a></li>
            
                <li><a href="../modules/moodle-core-maintenancemodetimer.html">moodle-core-maintenancemodetimer</a></li>
            
                <li><a href="../modules/moodle-core-notification.html">moodle-core-notification</a></li>
            
                <li><a href="../modules/moodle-core-notification-ajaxexception.html">moodle-core-notification-ajaxexception</a></li>
            
                <li><a href="../modules/moodle-core-notification-alert.html">moodle-core-notification-alert</a></li>
            
                <li><a href="../modules/moodle-core-notification-confirm.html">moodle-core-notification-confirm</a></li>
            
                <li><a href="../modules/moodle-core-notification-dialogue.html">moodle-core-notification-dialogue</a></li>
            
                <li><a href="../modules/moodle-core-notification-exception.html">moodle-core-notification-exception</a></li>
            
                <li><a href="../modules/moodle-core-popuphelp.html">moodle-core-popuphelp</a></li>
            
                <li><a href="../modules/moodle-core-tooltip.html">moodle-core-tooltip</a></li>
            
                <li><a href="../modules/moodle-core-widget-focusafterhide.html">moodle-core-widget-focusafterhide</a></li>
            
                <li><a href="../modules/moodle-course-categoryexpander.html">moodle-course-categoryexpander</a></li>
            
                <li><a href="../modules/moodle-course-coursebase.html">moodle-course-coursebase</a></li>
            
                <li><a href="../modules/moodle-course-dragdrop.html">moodle-course-dragdrop</a></li>
            
                <li><a href="../modules/moodle-course-management.html">moodle-course-management</a></li>
            
                <li><a href="../modules/moodle-course-modchooser.html">moodle-course-modchooser</a></li>
            
                <li><a href="../modules/moodle-course-toolboxes.html">moodle-course-toolboxes</a></li>
            
                <li><a href="../modules/moodle-course-util.html">moodle-course-util</a></li>
            
                <li><a href="../modules/moodle-course-util-cm.html">moodle-course-util-cm</a></li>
            
                <li><a href="../modules/moodle-course-util-section.html">moodle-course-util-section</a></li>
            
                <li><a href="../modules/moodle-editor_atto-editor.html">moodle-editor_atto-editor</a></li>
            
                <li><a href="../modules/moodle-editor_atto-menu.html">moodle-editor_atto-menu</a></li>
            
                <li><a href="../modules/moodle-editor_atto-plugin.html">moodle-editor_atto-plugin</a></li>
            
                <li><a href="../modules/moodle-form-shortforms.html">moodle-form-shortforms</a></li>
            
                <li><a href="../modules/moodle-form-showadvanced.html">moodle-form-showadvanced</a></li>
            
                <li><a href="../modules/moodle-mod_quiz-autosave.html">moodle-mod_quiz-autosave</a></li>
            
                <li><a href="../modules/moodle-question-preview.html">moodle-question-preview</a></li>
            
                <li><a href="../modules/moodle-tool_capability-search.html">moodle-tool_capability-search</a></li>
            
                <li><a href="../modules/plugin-base.html">plugin-base</a></li>
            
                <li><a href="../modules/styling.html">styling</a></li>
            
                <li><a href="../modules/textarea.html">textarea</a></li>
            
                <li><a href="../modules/theme_bootstrapbase-bootstrap.html">theme_bootstrapbase-bootstrap</a></li>
            
                <li><a href="../modules/toolbar.html">toolbar</a></li>
            
                <li><a href="../modules/toolbarnav.html">toolbarnav</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: mod/quiz/yui/src/autosave/js/autosave.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see &lt;http://www.gnu.org/licenses/&gt;.


/**
 * Auto-save functionality for during quiz attempts.
 *
 * @module moodle-mod_quiz-autosave
 */

/**
 * Auto-save functionality for during quiz attempts.
 *
 * @class M.mod_quiz.autosave
 */

M.mod_quiz = M.mod_quiz || {};
M.mod_quiz.autosave = {
    /**
     * The amount of time (in milliseconds) to wait between TinyMCE detections.
     *
     * @property TINYMCE_DETECTION_DELAY
     * @type Number
     * @default 500
     * @private
     */
    TINYMCE_DETECTION_DELAY:  500,

    /**
     * The number of times to try redetecting TinyMCE.
     *
     * @property TINYMCE_DETECTION_REPEATS
     * @type Number
     * @default 20
     * @private
     */
    TINYMCE_DETECTION_REPEATS: 20,

    /**
     * The delay (in milliseconds) between checking hidden input fields.
     *
     * @property WATCH_HIDDEN_DELAY
     * @type Number
     * @default 1000
     * @private
     */
    WATCH_HIDDEN_DELAY:      1000,

    /**
     * The number of failures to ignore before notifying the user.
     *
     * @property FAILURES_BEFORE_NOTIFY
     * @type Number
     * @default 1
     * @private
     */
    FAILURES_BEFORE_NOTIFY:     1,

    /**
     * The value to use when resetting the successful save counter.
     *
     * @property FIRST_SUCCESSFUL_SAVE
     * @static
     * @type Number
     * @default -1
     * @private
     */
    FIRST_SUCCESSFUL_SAVE:     -1,

    /**
     * The selectors used throughout this class.
     *
     * @property SELECTORS
     * @private
     * @type Object
     * @static
     */
    SELECTORS: {
        QUIZ_FORM:             &#x27;#responseform&#x27;,
        VALUE_CHANGE_ELEMENTS: &#x27;input, textarea&#x27;,
        CHANGE_ELEMENTS:       &#x27;input, select&#x27;,
        HIDDEN_INPUTS:         &#x27;input[type=hidden]&#x27;,
        CONNECTION_ERROR:      &#x27;#connection-error&#x27;,
        CONNECTION_OK:         &#x27;#connection-ok&#x27;
    },

    /**
     * The script which handles the autosaves.
     *
     * @property AUTOSAVE_HANDLER
     * @type String
     * @default M.cfg.wwwroot + &#x27;/mod/quiz/autosave.ajax.php&#x27;
     * @private
     */
    AUTOSAVE_HANDLER: M.cfg.wwwroot + &#x27;/mod/quiz/autosave.ajax.php&#x27;,

    /**
     * The delay (in milliseconds) between a change being made, and it being auto-saved.
     *
     * @property delay
     * @type Number
     * @default 120000
     * @private
     */
    delay: 120000,

    /**
     * A Node reference to the form we are monitoring.
     *
     * @property form
     * @type Node
     * @default null
     */
    form: null,

    /**
     * Whether the form has been modified since the last save started.
     *
     * @property dirty
     * @type boolean
     * @default false
     */
    dirty: false,

    /**
     * Timer object for the delay between form modifaction and the save starting.
     *
     * @property delay_timer
     * @type Object
     * @default null
     * @private
     */
    delay_timer: null,

    /**
     * Y.io transaction for the save ajax request.
     *
     * @property save_transaction
     * @type object
     * @default null
     */
    save_transaction: null,

    /**
     * Failed saves count.
     *
     * @property savefailures
     * @type Number
     * @default 0
     * @private
     */
    savefailures: 0,

    /**
     * Properly bound key change handler.
     *
     * @property editor_change_handler
     * @type EventHandle
     * @default null
     * @private
     */
    editor_change_handler: null,

    /**
     * Record of the value of all the hidden fields, last time they were checked.
     *
     * @property hidden_field_values
     * @type Object
     * @default {}
     */
    hidden_field_values: {},

    /**
     * Initialise the autosave code.
     *
     * @method init
     * @param {Number} delay the delay, in seconds, between a change being detected, and
     * a save happening.
     */
    init: function(delay) {
        this.form = Y.one(this.SELECTORS.QUIZ_FORM);
        if (!this.form) {
            Y.log(&#x27;No response form found. Why did you try to set up autosave?&#x27;);
            return;
        }

        this.delay = delay * 1000;

        this.form.delegate(&#x27;valuechange&#x27;, this.value_changed, this.SELECTORS.VALUE_CHANGE_ELEMENTS, this);
        this.form.delegate(&#x27;change&#x27;,      this.value_changed, this.SELECTORS.CHANGE_ELEMENTS,       this);
        this.form.on(&#x27;submit&#x27;, this.stop_autosaving, this);

        this.init_tinymce(this.TINYMCE_DETECTION_REPEATS);

        this.save_hidden_field_values();
        this.watch_hidden_fields();
    },

    save_hidden_field_values: function() {
        this.form.all(this.SELECTORS.HIDDEN_INPUTS).each(function(hidden) {
            var name  = hidden.get(&#x27;name&#x27;);
            if (!name) {
                return;
            }
            this.hidden_field_values[name] = hidden.get(&#x27;value&#x27;);
        }, this);
    },

    watch_hidden_fields: function() {
        this.detect_hidden_field_changes();
        Y.later(this.WATCH_HIDDEN_DELAY, this, this.watch_hidden_fields);
    },

    detect_hidden_field_changes: function() {
        this.form.all(this.SELECTORS.HIDDEN_INPUTS).each(function(hidden) {
            var name  = hidden.get(&#x27;name&#x27;),
                value = hidden.get(&#x27;value&#x27;);
            if (!name) {
                return;
            }
            if (!(name in this.hidden_field_values) || value !== this.hidden_field_values[name]) {
                this.hidden_field_values[name] = value;
                this.value_changed({target: hidden});
            }
        }, this);
    },

    /**
     * Initialise watching of TinyMCE specifically.
     *
     * Because TinyMCE might load slowly, and after us, we need to keep
     * trying, until we detect TinyMCE is there, or enough time has passed.
     * This is based on the TINYMCE_DETECTION_DELAY and
     * TINYMCE_DETECTION_REPEATS properties.
     *
     *
     * @method init_tinymce
     * @param {Number} repeatcount The number of attempts made so far.
     */
    init_tinymce: function(repeatcount) {
        if (typeof tinyMCE === &#x27;undefined&#x27;) {
            if (repeatcount &gt; 0) {
                Y.later(this.TINYMCE_DETECTION_DELAY, this, this.init_tinymce, [repeatcount - 1]);
            } else {
                Y.log(&#x27;Gave up looking for TinyMCE.&#x27;);
            }
            return;
        }

        Y.log(&#x27;Found TinyMCE.&#x27;);
        this.editor_change_handler = Y.bind(this.editor_changed, this);
        tinyMCE.onAddEditor.add(Y.bind(this.init_tinymce_editor, this));
    },

    /**
     * Initialise watching of a specific TinyMCE editor.
     *
     * @method init_tinymce_editor
     * @param {EventFacade} e
     * @param {Object} editor The TinyMCE editor object
     */
    init_tinymce_editor: function(e, editor) {
        Y.log(&#x27;Found TinyMCE editor &#x27; + editor.id + &#x27;.&#x27;);
        editor.onChange.add(this.editor_change_handler);
        editor.onRedo.add(this.editor_change_handler);
        editor.onUndo.add(this.editor_change_handler);
        editor.onKeyDown.add(this.editor_change_handler);
    },

    value_changed: function(e) {
        if (e.target.get(&#x27;name&#x27;) === &#x27;thispage&#x27; || e.target.get(&#x27;name&#x27;) === &#x27;scrollpos&#x27; ||
                e.target.get(&#x27;name&#x27;).match(/_:flagged$/)) {
            return; // Not interesting.
        }
        Y.log(&#x27;Detected a value change in element &#x27; + e.target.get(&#x27;name&#x27;) + &#x27;.&#x27;);
        this.start_save_timer_if_necessary();
    },

    editor_changed: function(editor) {
        Y.log(&#x27;Detected a value change in editor &#x27; + editor.id + &#x27;.&#x27;);
        this.start_save_timer_if_necessary();
    },

    start_save_timer_if_necessary: function() {
        this.dirty = true;

        if (this.delay_timer || this.save_transaction) {
            // Already counting down or daving.
            return;
        }

        this.start_save_timer();
    },

    start_save_timer: function() {
        this.cancel_delay();
        this.delay_timer = Y.later(this.delay, this, this.save_changes);
    },

    cancel_delay: function() {
        if (this.delay_timer &amp;&amp; this.delay_timer !== true) {
            this.delay_timer.cancel();
        }
        this.delay_timer = null;
    },

    save_changes: function() {
        this.cancel_delay();
        this.dirty = false;

        if (this.is_time_nearly_over()) {
            Y.log(&#x27;No more saving, time is nearly over.&#x27;);
            this.stop_autosaving();
            return;
        }

        Y.log(&#x27;Doing a save.&#x27;);
        if (typeof tinyMCE !== &#x27;undefined&#x27;) {
            tinyMCE.triggerSave();
        }
        this.save_transaction = Y.io(this.AUTOSAVE_HANDLER, {
            method:  &#x27;POST&#x27;,
            form:    {id: this.form},
            on:      {
                success: this.save_done,
                failure: this.save_failed
            },
            context: this
        });
    },

    save_done: function() {
        Y.log(&#x27;Save completed.&#x27;);
        this.save_transaction = null;

        if (this.dirty) {
            Y.log(&#x27;Dirty after save.&#x27;);
            this.start_save_timer();
        }

        if (this.savefailures &gt; 0) {
            Y.one(this.SELECTORS.CONNECTION_ERROR).hide();
            Y.one(this.SELECTORS.CONNECTION_OK).show();
            this.savefailures = this.FIRST_SUCCESSFUL_SAVE;
        } else if (this.savefailures === this.FIRST_SUCCESSFUL_SAVE) {
            Y.one(this.SELECTORS.CONNECTION_OK).hide();
            this.savefailures = 0;
        }
    },

    save_failed: function() {
        Y.log(&#x27;Save failed.&#x27;);
        this.save_transaction = null;

        // We want to retry soon.
        this.start_save_timer();

        this.savefailures = Math.max(1, this.savefailures + 1);
        if (this.savefailures === this.FAILURES_BEFORE_NOTIFY) {
            Y.one(this.SELECTORS.CONNECTION_ERROR).show();
            Y.one(this.SELECTORS.CONNECTION_OK).hide();
        }
    },

    is_time_nearly_over: function() {
        return M.mod_quiz.timer &amp;&amp; M.mod_quiz.timer.endtime &amp;&amp;
                (new Date().getTime() + 2*this.delay) &gt; M.mod_quiz.timer.endtime;
    },

    stop_autosaving: function() {
        this.cancel_delay();
        this.delay_timer = true;
        if (this.save_transaction) {
            this.save_transaction.abort();
        }
    }
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
