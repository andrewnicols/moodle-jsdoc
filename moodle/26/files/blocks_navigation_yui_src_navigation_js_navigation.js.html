<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>blocks/navigation/yui/src/navigation/js/navigation.js - Moodle</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Moodle"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.6.2+ (Build: 20140320)</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Bootstrap.Collapse.html">Bootstrap.Collapse</a></li>
            
                <li><a href="../classes/Bootstrap.Dropdown.html">Bootstrap.Dropdown</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationhighlight.html">M.assignfeedback_editpdf.annotationhighlight</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationline.html">M.assignfeedback_editpdf.annotationline</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationoval.html">M.assignfeedback_editpdf.annotationoval</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationpen.html">M.assignfeedback_editpdf.annotationpen</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationrectangle.html">M.assignfeedback_editpdf.annotationrectangle</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.annotationstamp.html">M.assignfeedback_editpdf.annotationstamp</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.colourpicker.dropdown.html">M.assignfeedback_editpdf.colourpicker.dropdown</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.comment.html">M.assignfeedback_editpdf.comment</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.drawable.html">M.assignfeedback_editpdf.drawable</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.edit.html">M.assignfeedback_editpdf.edit</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.editor.assignfeedback_editpdf.html">M.assignfeedback_editpdf.editor.assignfeedback_editpdf</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.editor.commentmenu.html">M.assignfeedback_editpdf.editor.commentmenu</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.editor.commentsearch.html">M.assignfeedback_editpdf.editor.commentsearch</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.editor.Editor.html">M.assignfeedback_editpdf.editor.Editor</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.editor.editor.html">M.assignfeedback_editpdf.editor.editor</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.point.html">M.assignfeedback_editpdf.point</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.quickcomment.html">M.assignfeedback_editpdf.quickcomment</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.quickcommentlist.html">M.assignfeedback_editpdf.quickcommentlist</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.rect.html">M.assignfeedback_editpdf.rect</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.stamppicker.dropdown.html">M.assignfeedback_editpdf.stamppicker.dropdown</a></li>
            
                <li><a href="../classes/M.assignfeedback_editpdf.widget.dropdown.dropdown.html">M.assignfeedback_editpdf.widget.dropdown.dropdown</a></li>
            
                <li><a href="../classes/M.block_navigation.html">M.block_navigation</a></li>
            
                <li><a href="../classes/M.block_navigation.ActionKey.html">M.block_navigation.ActionKey</a></li>
            
                <li><a href="../classes/M.block_navigation.Branch.html">M.block_navigation.Branch</a></li>
            
                <li><a href="../classes/M.block_navigation.Tree.html">M.block_navigation.Tree</a></li>
            
                <li><a href="../classes/M.core.html">M.core</a></li>
            
                <li><a href="../classes/M.core.actionmenu.html">M.core.actionmenu</a></li>
            
                <li><a href="../classes/M.core.actionmenu.ActionMenu.html">M.core.actionmenu.ActionMenu</a></li>
            
                <li><a href="../classes/M.core.ajaxException.html">M.core.ajaxException</a></li>
            
                <li><a href="../classes/M.core.alert.html">M.core.alert</a></li>
            
                <li><a href="../classes/M.core.blockdraganddrop.html">M.core.blockdraganddrop</a></li>
            
                <li><a href="../classes/M.core.blockdraganddrop.BlockRegion.html">M.core.blockdraganddrop.BlockRegion</a></li>
            
                <li><a href="../classes/M.core.blockdraganddrop.LegacyManager.html">M.core.blockdraganddrop.LegacyManager</a></li>
            
                <li><a href="../classes/M.core.blockdraganddrop.Manager.html">M.core.blockdraganddrop.Manager</a></li>
            
                <li><a href="../classes/M.core.confirm.html">M.core.confirm</a></li>
            
                <li><a href="../classes/M.core.core.html">M.core.core</a></li>
            
                <li><a href="../classes/M.core.dialogue.html">M.core.dialogue</a></li>
            
                <li><a href="../classes/M.core.dock.html">M.core.dock</a></li>
            
                <li><a href="../classes/M.core.dock.ActionKey.html">M.core.dock.ActionKey</a></li>
            
                <li><a href="../classes/M.core.dock.Block.html">M.core.dock.Block</a></li>
            
                <li><a href="../classes/M.core.dock.Dock.html">M.core.dock.Dock</a></li>
            
                <li><a href="../classes/M.core.dock.DockedItem.html">M.core.dock.DockedItem</a></li>
            
                <li><a href="../classes/M.core.dock.Loader.html">M.core.dock.Loader</a></li>
            
                <li><a href="../classes/M.core.dock.Panel.html">M.core.dock.Panel</a></li>
            
                <li><a href="../classes/M.core.dock.TabHeightManager.html">M.core.dock.TabHeightManager</a></li>
            
                <li><a href="../classes/M.core.exception.html">M.core.exception</a></li>
            
                <li><a href="../classes/M.core.LockScroll.html">M.core.LockScroll</a></li>
            
                <li><a href="../classes/M.core.notification.html">M.core.notification</a></li>
            
                <li><a href="../classes/M.core.tooltip.html">M.core.tooltip</a></li>
            
                <li><a href="../classes/M.course.management.Category.html">M.course.management.Category</a></li>
            
                <li><a href="../classes/M.course.management.Console.html">M.course.management.Console</a></li>
            
                <li><a href="../classes/M.course.management.Course.html">M.course.management.Course</a></li>
            
                <li><a href="../classes/M.course.management.DragDrop.html">M.course.management.DragDrop</a></li>
            
                <li><a href="../classes/M.course.management.Item.html">M.course.management.Item</a></li>
            
                <li><a href="../classes/M.tool_capability.search.Search.html">M.tool_capability.search.Search</a></li>
            
                <li><a href="../classes/M.tool_capability.search.tool_capability.html">M.tool_capability.search.tool_capability</a></li>
            
                <li><a href="../classes/Moodle.core_course.util.html">Moodle.core_course.util</a></li>
            
                <li><a href="../classes/Moodle.core_course.util.cm.html">Moodle.core_course.util.cm</a></li>
            
                <li><a href="../classes/Moodle.core_course.util.section.html">Moodle.core_course.util.section</a></li>
            
                <li><a href="../classes/Moodle.theme_bootstrapbase.bootstrap.html">Moodle.theme_bootstrapbase.bootstrap</a></li>
            
                <li><a href="../classes/TreeView.html">TreeView</a></li>
            
                <li><a href="../classes/TreeView.Sortable.html">TreeView.Sortable</a></li>
            
                <li><a href="../classes/Y.BootstrapEngine.html">Y.BootstrapEngine</a></li>
            
                <li><a href="../classes/Y.Moodle.course.categoryexpander.html">Y.Moodle.course.categoryexpander</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/gallery-bootstrap-collapse.html">gallery-bootstrap-collapse</a></li>
            
                <li><a href="../modules/gallery-bootstrap-dropdown.html">gallery-bootstrap-dropdown</a></li>
            
                <li><a href="../modules/gallery-bootstrap-engine.html">gallery-bootstrap-engine</a></li>
            
                <li><a href="../modules/gallery-sm-treeview.html">gallery-sm-treeview</a></li>
            
                <li><a href="../modules/gallery-sm-treeview-sortable.html">gallery-sm-treeview-sortable</a></li>
            
                <li><a href="../modules/moodle-assignfeedback_editpdf-editor.html">moodle-assignfeedback_editpdf-editor</a></li>
            
                <li><a href="../modules/moodle-block_navigation-navigation.html">moodle-block_navigation-navigation</a></li>
            
                <li><a href="../modules/moodle-core-actionmenu.html">moodle-core-actionmenu</a></li>
            
                <li><a href="../modules/moodle-core-blockdraganddrop.html">moodle-core-blockdraganddrop</a></li>
            
                <li><a href="../modules/moodle-core-dock.html">moodle-core-dock</a></li>
            
                <li><a href="../modules/moodle-core-lockscroll.html">moodle-core-lockscroll</a></li>
            
                <li><a href="../modules/moodle-core-notification.html">moodle-core-notification</a></li>
            
                <li><a href="../modules/moodle-core-notification-ajaxexception.html">moodle-core-notification-ajaxexception</a></li>
            
                <li><a href="../modules/moodle-core-notification-alert.html">moodle-core-notification-alert</a></li>
            
                <li><a href="../modules/moodle-core-notification-confirm.html">moodle-core-notification-confirm</a></li>
            
                <li><a href="../modules/moodle-core-notification-dialogue.html">moodle-core-notification-dialogue</a></li>
            
                <li><a href="../modules/moodle-core-notification-exception.html">moodle-core-notification-exception</a></li>
            
                <li><a href="../modules/moodle-core-tooltip.html">moodle-core-tooltip</a></li>
            
                <li><a href="../modules/moodle-course-categoryexpander.html">moodle-course-categoryexpander</a></li>
            
                <li><a href="../modules/moodle-course-management.html">moodle-course-management</a></li>
            
                <li><a href="../modules/moodle-course-util.html">moodle-course-util</a></li>
            
                <li><a href="../modules/moodle-course-util-cm.html">moodle-course-util-cm</a></li>
            
                <li><a href="../modules/moodle-course-util-section.html">moodle-course-util-section</a></li>
            
                <li><a href="../modules/moodle-tool_capability-search.html">moodle-tool_capability-search</a></li>
            
                <li><a href="../modules/theme_bootstrapbase-bootstrap.html">theme_bootstrapbase-bootstrap</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: blocks/navigation/yui/src/navigation/js/navigation.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Navigation block JS.
 *
 * This file contains the Navigation block JS..
 *
 * @module moodle-block_navigation-navigation
 */

/**
 * This namespace will contain all of the contents of the navigation blocks
 * global navigation and settings.
 * @namespace M
 * @class block_navigation
 * @static
 */
M.block_navigation = M.block_navigation || {};
/**
 * The number of expandable branches in existence.
 *
 * @property expandablebranchcount
 * @protected
 * @static
 */
M.block_navigation.expandablebranchcount = 1;
/**
 * The maximum number of courses to show as part of a branch.
 *
 * @property courselimit
 * @protected
 * @static
 */
M.block_navigation.courselimit = 20;
/**
 * Add new instance of navigation tree to tree collection
 *
 * @method init_add_tree
 * @static
 * @param {Object} properties
 */
M.block_navigation.init_add_tree = function(properties) {
    if (properties.courselimit) {
        this.courselimit = properties.courselimit;
    }
    new TREE(properties);
};

/**
 * A &#x27;actionkey&#x27; Event to help with Y.delegate().
 * The event consists of the left arrow, right arrow, enter and space keys.
 * More keys can be mapped to action meanings.
 * actions: collapse , expand, toggle, enter.
 *
 * This event is delegated to branches in the navigation tree.
 * The on() method to subscribe allows specifying the desired trigger actions as JSON.
 *
 * @namespace M.block_navigation
 * @class ActionKey
 */
Y.Event.define(&quot;actionkey&quot;, {
    // Webkit and IE repeat keydown when you hold down arrow keys.
    // Opera links keypress to page scroll; others keydown.
    // Firefox prevents page scroll via preventDefault() on either
    // keydown or keypress.
    _event: (Y.UA.webkit || Y.UA.ie) ? &#x27;keydown&#x27; : &#x27;keypress&#x27;,

    /**
     * The keys to trigger on.
     * @method _keys
     */
    _keys: {
        //arrows
        &#x27;37&#x27;: &#x27;collapse&#x27;,
        &#x27;39&#x27;: &#x27;expand&#x27;,
        &#x27;32&#x27;: &#x27;toggle&#x27;,
        &#x27;13&#x27;: &#x27;enter&#x27;
    },

    /**
     * Handles key events
     * @method _keyHandler
     * @param {EventFacade} e
     * @param {SyntheticEvent.Notifier} notifier The notifier used to trigger the execution of subscribers
     * @param {Object} args
     */
    _keyHandler: function (e, notifier, args) {
        var actObj;
        if (!args.actions) {
            actObj = {collapse:true, expand:true, toggle:true, enter:true};
        } else {
            actObj = args.actions;
        }
        if (this._keys[e.keyCode] &amp;&amp; actObj[this._keys[e.keyCode]]) {
            e.action = this._keys[e.keyCode];
            notifier.fire(e);
        }
    },

    /**
     * Subscribes to events.
     * @method on
     * @param {Node} node The node this subscription was applied to.
     * @param {Subscription} sub The object tracking this subscription.
     * @param {SyntheticEvent.Notifier} notifier The notifier used to trigger the execution of subscribers
     */
    on: function (node, sub, notifier) {
        // subscribe to _event and ask keyHandler to handle with given args[0] (the desired actions).
        if (sub.args === null) {
            //no actions given
            sub._detacher = node.on(this._event, this._keyHandler,this, notifier, {actions:false});
        } else {
            sub._detacher = node.on(this._event, this._keyHandler,this, notifier, sub.args[0]);
        }
    },

    /**
     * Detaches an event listener
     * @method detach
     */
    detach: function (node, sub) {
        //detach our _detacher handle of the subscription made in on()
        sub._detacher.detach();
    },

    /**
     * Creates a delegated event listener.
     * @method delegate
     * @param {Node} node The node this subscription was applied to.
     * @param {Subscription} sub The object tracking this subscription.
     * @param {SyntheticEvent.Notifier} notifier The notifier used to trigger the execution of subscribers
     * @param {String|function} filter Selector string or function that accpets an event object and returns null.
     */
    delegate: function (node, sub, notifier, filter) {
        // subscribe to _event and ask keyHandler to handle with given args[0] (the desired actions).
        if (sub.args === null) {
            //no actions given
            sub._delegateDetacher = node.delegate(this._event, this._keyHandler,filter, this, notifier, {actions:false});
        } else {
            sub._delegateDetacher = node.delegate(this._event, this._keyHandler,filter, this, notifier, sub.args[0]);
        }
    },

    /**
     * Detaches a delegated event listener.
     * @method detachDelegate
     * @param {Node} node The node this subscription was applied to.
     * @param {Subscription} sub The object tracking this subscription.
     * @param {SyntheticEvent.Notifier} notifier The notifier used to trigger the execution of subscribers
     * @param {String|function} filter Selector string or function that accpets an event object and returns null.
     */
    detachDelegate: function (node, sub) {
        sub._delegateDetacher.detach();
    }
});

var EXPANSIONLIMIT_EVERYTHING = 0,
    EXPANSIONLIMIT_COURSE     = 20,
    EXPANSIONLIMIT_SECTION    = 30,
    EXPANSIONLIMIT_ACTIVITY   = 40;

// Mappings for the different types of nodes coming from the navigation.
// Copied from lib/navigationlib.php navigation_node constants.
var NODETYPE = {
    // @type int Root node = 0
    ROOTNODE : 0,
    // @type int System context = 1
    SYSTEM : 1,
    // @type int Course category = 10
    CATEGORY : 10,
    // @type int MYCATEGORY = 11
    MYCATEGORY : 11,
    // @type int Course = 20
    COURSE : 20,
    // @type int Course section = 30
    SECTION : 30,
    // @type int Activity (course module) = 40
    ACTIVITY : 40,
    // @type int Resource (course module = 50
    RESOURCE : 50,
    // @type int Custom node (could be anything) = 60
    CUSTOM : 60,
    // @type int Setting = 70
    SETTING : 70,
    // @type int site administration = 71
    SITEADMIN : 71,
    // @type int User context = 80
    USER : 80,
    // @type int Container = 90
    CONTAINER : 90
};

/**
 * Navigation tree class.
 *
 * This class establishes the tree initially, creating expandable branches as
 * required, and delegating the expand/collapse event.
 *
 * @namespace M.block_navigation
 * @class Tree
 * @constructor
 * @extends Y.Base
 */
var TREE = function() {
    TREE.superclass.constructor.apply(this, arguments);
};
TREE.prototype = {
    /**
     * The tree&#x27;s ID, normally its block instance id.
     * @property id
     * @type Int
     * @protected
     */
    id : null,
    /**
     * An array of initialised branches.
     * @property branches
     * @type Array
     * @protected
     */
    branches : [],
    /**
     * Initialise the tree object when its first created.
     * @method initializer
     * @param {Object} config
     */
    initializer : function(config) {
        Y.log(&#x27;Initialising navigation block tree&#x27;, &#x27;note&#x27;, &#x27;moodle-block_navigation&#x27;);

        this.id = parseInt(config.id, 10);

        var node = Y.one(&#x27;#inst&#x27;+config.id);

        // Can&#x27;t find the block instance within the page
        if (node === null) {
            return;
        }

        // Delegate event to toggle expansion
        Y.delegate(&#x27;click&#x27;, this.toggleExpansion, node.one(&#x27;.block_tree&#x27;), &#x27;.tree_item.branch&#x27;, this);
        Y.delegate(&#x27;actionkey&#x27;, this.toggleExpansion, node.one(&#x27;.block_tree&#x27;), &#x27;.tree_item.branch&#x27;, this);

        // Gather the expandable branches ready for initialisation.
        var expansions = [];
        if (config.expansions) {
            expansions = config.expansions;
        } else if (window[&#x27;navtreeexpansions&#x27;+config.id]) {
            expansions = window[&#x27;navtreeexpansions&#x27;+config.id];
        }
        // Establish each expandable branch as a tree branch.
        for (var i in expansions) {
            var branch = new BRANCH({
                tree:this,
                branchobj:expansions[i],
                overrides : {
                    expandable : true,
                    children : [],
                    haschildren : true
                }
            }).wire();
            M.block_navigation.expandablebranchcount++;
            this.branches[branch.get(&#x27;id&#x27;)] = branch;
        }
        // Create siteadmin branch.
        if (window.siteadminexpansion) {
            var siteadminbranch = new BRANCH({
                tree: this,
                branchobj: window.siteadminexpansion,
                overrides : {
                    expandable : true,
                    children : [],
                    haschildren : true
                }
            }).wire();
            M.block_navigation.expandablebranchcount++;
            this.branches[siteadminbranch.get(&#x27;id&#x27;)] = siteadminbranch;
            // Remove link on site admin with JS to keep old UI.
            var siteadminlinknode = siteadminbranch.node.get(&#x27;childNodes&#x27;).item(0);
            if (siteadminlinknode) {
                var siteadminnode = Y.Node.create(&#x27;&lt;span tabindex=&quot;0&quot;&gt;&#x27;+siteadminlinknode.get(&#x27;innerHTML&#x27;)+&#x27;&lt;/span&gt;&#x27;);
                siteadminbranch.node.replaceChild(siteadminnode, siteadminlinknode);
            }
        }
        if (M.block_navigation.expandablebranchcount &gt; 0) {
            // Delegate some events to handle AJAX loading.
            Y.delegate(&#x27;click&#x27;, this.fire_branch_action, node.one(&#x27;.block_tree&#x27;), &#x27;.tree_item.branch[data-expandable]&#x27;, this);
            Y.delegate(&#x27;actionkey&#x27;, this.fire_branch_action, node.one(&#x27;.block_tree&#x27;), &#x27;.tree_item.branch[data-expandable]&#x27;, this);
        }
    },
    /**
     * Fire actions for a branch when an event occurs.
     * @method fire_branch_action
     * @param {EventFacade} event
     */
    fire_branch_action : function(event) {
        var id = event.currentTarget.getAttribute(&#x27;id&#x27;);
        var branch = this.branches[id];
        branch.ajaxLoad(event);
    },
    /**
     * This is a callback function responsible for expanding and collapsing the
     * branches of the tree. It is delegated to rather than multiple event handles.
     * @method toggleExpansion
     * @param {EventFacade} e
     * @return Boolean
     */
    toggleExpansion : function(e) {
        // First check if they managed to click on the li iteslf, then find the closest
        // LI ancestor and use that

        if (e.target.test(&#x27;a&#x27;) &amp;&amp; (e.keyCode === 0 || e.keyCode === 13)) {
            // A link has been clicked (or keypress is &#x27;enter&#x27;) don&#x27;t fire any more events just do the default.
            e.stopPropagation();
            return;
        }

        // Makes sure we can get to the LI containing the branch.
        var target = e.target;
        if (!target.test(&#x27;li&#x27;)) {
            target = target.ancestor(&#x27;li&#x27;);
        }
        if (!target) {
            return;
        }

        // Toggle expand/collapse providing its not a root level branch.
        if (!target.hasClass(&#x27;depth_1&#x27;)) {
            if (e.type === &#x27;actionkey&#x27;) {
                switch (e.action) {
                    case &#x27;expand&#x27; :
                        target.removeClass(&#x27;collapsed&#x27;);
                        target.set(&#x27;aria-expanded&#x27;, true);
                        break;
                    case &#x27;collapse&#x27; :
                        target.addClass(&#x27;collapsed&#x27;);
                        target.set(&#x27;aria-expanded&#x27;, false);
                        break;
                    default :
                        target.toggleClass(&#x27;collapsed&#x27;);
                        target.set(&#x27;aria-expanded&#x27;, !target.hasClass(&#x27;collapsed&#x27;));
                }
                e.halt();
            } else {
                target.toggleClass(&#x27;collapsed&#x27;);
                target.set(&#x27;aria-expanded&#x27;, !target.hasClass(&#x27;collapsed&#x27;));
            }
        }

        // If the accordian feature has been enabled collapse all siblings.
        if (this.get(&#x27;accordian&#x27;)) {
            target.siblings(&#x27;li&#x27;).each(function(){
                if (this.get(&#x27;id&#x27;) !== target.get(&#x27;id&#x27;) &amp;&amp; !this.hasClass(&#x27;collapsed&#x27;)) {
                    this.addClass(&#x27;collapsed&#x27;);
                    this.set(&#x27;aria-expanded&#x27;, false);
                }
            });
        }

        // If this block can dock tell the dock to resize if required and check
        // the width on the dock panel in case it is presently in use.
        if (this.get(&#x27;candock&#x27;) &amp;&amp; M.core.dock.notifyBlockChange) {
            M.core.dock.notifyBlockChange(this.id);
        }
        return true;

    }
};
// The tree extends the YUI base foundation.
Y.extend(TREE, Y.Base, TREE.prototype, {
    NAME : &#x27;navigation-tree&#x27;,
    ATTRS : {
        /**
         * True if the block can dock.
         * @attribute candock
         * @type Boolean
         */
        candock : {
            validator : Y.Lang.isBool,
            value : false
        },
        /**
         * If set to true nodes will be opened/closed in an accordian fashion.
         * @attribute accordian
         * @type Boolean
         */
        accordian : {
            validator : Y.Lang.isBool,
            value : false
        },
        /**
         * The nodes that get shown.
         * @attribute expansionlimit
         * @type Integer
         */
        expansionlimit : {
            value : 0,
            setter : function(val) {
                val = parseInt(val, 10);
                if (val !== EXPANSIONLIMIT_EVERYTHING &amp;&amp;
                    val !== EXPANSIONLIMIT_COURSE &amp;&amp;
                    val !== EXPANSIONLIMIT_SECTION &amp;&amp;
                    val !== EXPANSIONLIMIT_ACTIVITY) {
                    val = EXPANSIONLIMIT_EVERYTHING;
                }
                return val;
            }
        },
        /**
         * The navigation tree block instance.
         */
        instance : {
            value : false,
            setter : function(val) {
                return parseInt(val, 10);
            }
        }
    }
});

/**
 * The Branch class.
 *
 * This class is used to manage a tree branch, in particular its ability to load
 * its contents by AJAX.
 *
 * @namespace M.block_navigation
 * @class Branch
 * @constructor
 * @extends Y.Base
 */
BRANCH = function() {
    BRANCH.superclass.constructor.apply(this, arguments);
};
BRANCH.prototype = {
    /**
     * The node for this branch (p)
     * @property node
     * @type Node
     * @protected
     */
    node : null,
    /**
     * Initialises the branch when it is first created.
     * @method initializer
     * @param {Object} config
     */
    initializer : function(config) {
        var i,
            children;
        if (config.branchobj !== null) {
            // Construct from the provided xml
            for (i in config.branchobj) {
                this.set(i, config.branchobj[i]);
            }
            children = this.get(&#x27;children&#x27;);
            this.set(&#x27;haschildren&#x27;, (children.length &gt; 0));
        }
        if (config.overrides !== null) {
            // Construct from the provided xml
            for (i in config.overrides) {
                this.set(i, config.overrides[i]);
            }
        }
        // Get the node for this branch
        this.node = Y.one(&#x27;#&#x27;+this.get(&#x27;id&#x27;));
        var expansionlimit = this.get(&#x27;tree&#x27;).get(&#x27;expansionlimit&#x27;);
        var type = this.get(&#x27;type&#x27;);
        if (expansionlimit !== EXPANSIONLIMIT_EVERYTHING &amp;&amp;  type &gt;= expansionlimit &amp;&amp; type &lt;= EXPANSIONLIMIT_ACTIVITY) {
            this.set(&#x27;expandable&#x27;, false);
            this.set(&#x27;haschildren&#x27;, false);
        }
    },
    /**
     * Draws the branch within the tree.
     *
     * This function creates a DOM structure for the branch and then injects
     * it into the navigation tree at the correct point.
     *
     * @method draw
     * @chainable
     * @param {Node} element
     * @return Branch
     */
    draw : function(element) {

        var isbranch = (this.get(&#x27;expandable&#x27;) || this.get(&#x27;haschildren&#x27;));
        var branchli = Y.Node.create(&#x27;&lt;li&gt;&lt;/li&gt;&#x27;);
        var link = this.get(&#x27;link&#x27;);
        var branchp = Y.Node.create(&#x27;&lt;p class=&quot;tree_item&quot;&gt;&lt;/p&gt;&#x27;).setAttribute(&#x27;id&#x27;, this.get(&#x27;id&#x27;));
        if (!link) {
            //add tab focus if not link (so still one focus per menu node).
            // it was suggested to have 2 foci. one for the node and one for the link in MDL-27428.
            branchp.setAttribute(&#x27;tabindex&#x27;, &#x27;0&#x27;);
        }
        if (isbranch) {
            branchli.addClass(&#x27;collapsed&#x27;).addClass(&#x27;contains_branch&#x27;);
            branchli.set(&#x27;aria-expanded&#x27;, false);
            branchp.addClass(&#x27;branch&#x27;);
        }

        // Prepare the icon, should be an object representing a pix_icon
        var branchicon = false;
        var icon = this.get(&#x27;icon&#x27;);
        if (icon &amp;&amp; (!isbranch || this.get(&#x27;type&#x27;) === NODETYPE.ACTIVITY)) {
            branchicon = Y.Node.create(&#x27;&lt;img alt=&quot;&quot; /&gt;&#x27;);
            branchicon.setAttribute(&#x27;src&#x27;, M.util.image_url(icon.pix, icon.component));
            branchli.addClass(&#x27;item_with_icon&#x27;);
            if (icon.alt) {
                branchicon.setAttribute(&#x27;alt&#x27;, icon.alt);
            }
            if (icon.title) {
                branchicon.setAttribute(&#x27;title&#x27;, icon.title);
            }
            if (icon.classes) {
                for (var i in icon.classes) {
                    branchicon.addClass(icon.classes[i]);
                }
            }
        }

        if (!link) {
            var branchspan = Y.Node.create(&#x27;&lt;span&gt;&lt;/span&gt;&#x27;);
            if (branchicon) {
                branchspan.appendChild(branchicon);
            }
            branchspan.append(this.get(&#x27;name&#x27;));
            if (this.get(&#x27;hidden&#x27;)) {
                branchspan.addClass(&#x27;dimmed_text&#x27;);
            }
            branchp.appendChild(branchspan);
        } else {
            var branchlink = Y.Node.create(&#x27;&lt;a title=&quot;&#x27;+this.get(&#x27;title&#x27;)+&#x27;&quot; href=&quot;&#x27;+link+&#x27;&quot;&gt;&lt;/a&gt;&#x27;);
            if (branchicon) {
                branchlink.appendChild(branchicon);
            }
            branchlink.append(this.get(&#x27;name&#x27;));
            if (this.get(&#x27;hidden&#x27;)) {
                branchlink.addClass(&#x27;dimmed&#x27;);
            }
            branchp.appendChild(branchlink);
        }

        branchli.appendChild(branchp);
        element.appendChild(branchli);
        this.node = branchp;
        return this;
    },
    /**
     * Attaches required events to the branch structure.
     *
     * @chainable
     * @method wire
     * @return {BRANCH} This function is chainable, it always returns itself.
     */
    wire : function() {
        this.node = this.node || Y.one(&#x27;#&#x27;+this.get(&#x27;id&#x27;));
        if (!this.node) {
            return this;
        }
        if (this.get(&#x27;expandable&#x27;)) {
            this.node.setAttribute(&#x27;data-expandable&#x27;, &#x27;1&#x27;);
            this.node.setAttribute(&#x27;data-loaded&#x27;, &#x27;0&#x27;);
        }
        return this;
    },
    /**
     * Gets the UL element that children for this branch should be inserted into.
     * @method getChildrenUL
     * @return Node
     */
    getChildrenUL : function() {
        var ul = this.node.next(&#x27;ul&#x27;);
        if (!ul) {
            ul = Y.Node.create(&#x27;&lt;ul&gt;&lt;/ul&gt;&#x27;);
            this.node.ancestor().append(ul);
        }
        return ul;
    },
    /**
     * Load the content of the branch via AJAX.
     *
     * This function calls ajaxProcessResponse with the result of the AJAX
     * request made here.
     *
     * @method ajaxLoad
     * @param {EventFacade} e
     * @return Bool
     */
    ajaxLoad : function(e) {
        if (e.type === &#x27;actionkey&#x27; &amp;&amp; e.action !== &#x27;enter&#x27;) {
            e.halt();
        } else {
            e.stopPropagation();
        }
        if ((e.type === &#x27;actionkey&#x27; &amp;&amp; e.action === &#x27;enter&#x27;) || e.target.test(&#x27;a&#x27;)) {
            // No ajaxLoad for enter.
            this.node.setAttribute(&#x27;data-expandable&#x27;, &#x27;0&#x27;);
            this.node.setAttribute(&#x27;data-loaded&#x27;, &#x27;1&#x27;);
            return true;
        }

        if (this.node.hasClass(&#x27;loadingbranch&#x27;)) {
            // Already loading. Just skip.
            return true;
        }

        if (this.node.getAttribute(&#x27;data-loaded&#x27;) === &#x27;1&#x27;) {
            // We&#x27;ve already loaded this stuff.
            return true;
        }
        Y.log(&#x27;Loading navigation branch via AJAX: &#x27;+this.get(&#x27;key&#x27;), &#x27;note&#x27;, &#x27;moodle-block_navigation&#x27;);
        this.node.addClass(&#x27;loadingbranch&#x27;);

        var params = {
            elementid : this.get(&#x27;id&#x27;),
            id : this.get(&#x27;key&#x27;),
            type : this.get(&#x27;type&#x27;),
            sesskey : M.cfg.sesskey,
            instance : this.get(&#x27;tree&#x27;).get(&#x27;instance&#x27;)
        };

        var ajaxfile = &#x27;/lib/ajax/getnavbranch.php&#x27;;
        // For siteadmin navigation get tree from getsiteadminbranch.php.
        if (this.get(&#x27;type&#x27;) === NODETYPE.SITEADMIN) {
            ajaxfile = &#x27;/lib/ajax/getsiteadminbranch.php&#x27;;
        }

        Y.io(M.cfg.wwwroot + ajaxfile, {
            method:&#x27;POST&#x27;,
            data:  build_querystring(params),
            on: {
                complete: this.ajaxProcessResponse
            },
            context:this
        });
        return true;
    },
    /**
     * Processes an AJAX request to load the content of this branch through
     * AJAX.
     *
     * @method ajaxProcessResponse
     * @param {Int} tid The transaction id.
     * @param {Object} outcome
     * @return Boolean
     */
    ajaxProcessResponse : function(tid, outcome) {
        this.node.removeClass(&#x27;loadingbranch&#x27;);
        this.node.setAttribute(&#x27;data-loaded&#x27;, &#x27;1&#x27;);
        try {
            var object = Y.JSON.parse(outcome.responseText);
            if (object.error) {
                Y.use(&#x27;moodle-core-notification-ajaxexception&#x27;, function () {
                    return new M.core.ajaxException(object).show();
                });
                return false;
            }
            if (object.children &amp;&amp; object.children.length &gt; 0) {
                var coursecount = 0;
                for (var i in object.children) {
                    if (typeof(object.children[i])===&#x27;object&#x27;) {
                        if (object.children[i].type === NODETYPE.COURSE) {
                            coursecount++;
                        }
                        this.addChild(object.children[i]);
                    }
                }
                if ((this.get(&#x27;type&#x27;) === NODETYPE.CATEGORY || this.get(&#x27;type&#x27;) === NODETYPE.ROOTNODE || this.get(&#x27;type&#x27;) === NODETYPE.MYCATEGORY)
                    &amp;&amp; coursecount &gt;= M.block_navigation.courselimit) {
                    this.addViewAllCoursesChild(this);
                }
                Y.log(&#x27;AJAX loading complete.&#x27;, &#x27;note&#x27;, &#x27;moodle-block_navigation&#x27;);
                // If this block can dock tell the dock to resize if required and check
                // the width on the dock panel in case it is presently in use.
                if (this.get(&#x27;tree&#x27;).get(&#x27;candock&#x27;) &amp;&amp; M.core.dock.notifyBlockChange) {
                    M.core.dock.notifyBlockChange(this.get(&#x27;tree&#x27;).id);
                }
                return true;
            }
            Y.log(&#x27;AJAX loading complete but there were no children.&#x27;, &#x27;note&#x27;, &#x27;moodle-block_navigation&#x27;);
        } catch (error) {
            if (outcome &amp;&amp; outcome.status &amp;&amp; outcome.status &gt; 0) {
                // If we got here then there was an error parsing the result.
                Y.log(&#x27;Error parsing AJAX response or adding branches to the navigation tree&#x27;, &#x27;error&#x27;, &#x27;moodle-block_navigation&#x27;);
                Y.use(&#x27;moodle-core-notification-exception&#x27;, function () {
                    return new M.core.exception(error).show();
                });
            }

            return false;
        }
        // The branch is empty so class it accordingly
        this.node.replaceClass(&#x27;branch&#x27;, &#x27;emptybranch&#x27;);
        return true;
    },
    /**
     * Turns the branch object passed to the method into a proper branch object
     * and then adds it as a child of this branch.
     *
     * @method addChild
     * @param {Object} branchobj
     * @return Boolean
     */
    addChild : function(branchobj) {
        // Make the new branch into an object
        var branch = new BRANCH({tree:this.get(&#x27;tree&#x27;), branchobj:branchobj});
        if (branch.draw(this.getChildrenUL())) {
            this.get(&#x27;tree&#x27;).branches[branch.get(&#x27;id&#x27;)] = branch;
            branch.wire();
            var count = 0, i, children = branch.get(&#x27;children&#x27;);
            for (i in children) {
                // Add each branch to the tree
                if (children[i].type === NODETYPE.COURSE) {
                    count++;
                }
                if (typeof(children[i]) === &#x27;object&#x27;) {
                    branch.addChild(children[i]);
                }
            }
            if ((branch.get(&#x27;type&#x27;) === NODETYPE.CATEGORY || branch.get(&#x27;type&#x27;) === NODETYPE.MYCATEGORY)
                &amp;&amp; count &gt;= M.block_navigation.courselimit) {
                this.addViewAllCoursesChild(branch);
            }
        }
        return true;
    },

    /**
     * Add a link to view all courses in a category
     *
     * @method addViewAllCoursesChild
     * @param {BRANCH} branch
     */
    addViewAllCoursesChild: function(branch) {
        var url = null;
        if (branch.get(&#x27;type&#x27;) === NODETYPE.ROOTNODE) {
            if (branch.get(&#x27;key&#x27;) === &#x27;mycourses&#x27;) {
                url = M.cfg.wwwroot + &#x27;/my&#x27;;
            } else {
                url = M.cfg.wwwroot + &#x27;/course/index.php&#x27;;
            }
        } else {
            url = M.cfg.wwwroot+&#x27;/course/index.php?categoryid=&#x27; + branch.get(&#x27;key&#x27;);
        }
        branch.addChild({
            name : M.str.moodle.viewallcourses,
            title : M.str.moodle.viewallcourses,
            link : url,
            haschildren : false,
            icon : {&#x27;pix&#x27;:&quot;i/navigationitem&quot;,&#x27;component&#x27;:&#x27;moodle&#x27;}
        });
    }
};
Y.extend(BRANCH, Y.Base, BRANCH.prototype, {
    NAME : &#x27;navigation-branch&#x27;,
    ATTRS : {
        /**
         * The Tree this branch belongs to.
         * @attribute tree
         * @type TREE
         * @required
         * @writeOnce
         */
        tree : {
            writeOnce : &#x27;initOnly&#x27;,
            validator : Y.Lang.isObject
        },
        /**
         * The name of this branch.
         * @attribute name
         * @type String
         */
        name : {
            value : &#x27;&#x27;,
            validator : Y.Lang.isString,
            setter : function(val) {
                return val.replace(/\n/g, &#x27;&lt;br /&gt;&#x27;);
            }
        },
        /**
         * The title to use for this branch.
         * @attribute title
         * @type String
         */
        title : {
            value : &#x27;&#x27;,
            validator : Y.Lang.isString
        },
        /**
         * The ID of this branch.
         * The ID and Type should always form a unique pair.
         * @attribute id
         * @type String
         */
        id : {
            value : &#x27;&#x27;,
            validator : Y.Lang.isString,
            getter : function(val) {
                if (val === &#x27;&#x27;) {
                    val = &#x27;expandable_branch_&#x27;+M.block_navigation.expandablebranchcount;
                    M.block_navigation.expandablebranchcount++;
                }
                return val;
            }
        },
        /**
         * The key used to identify this branch easily if there is one.
         * @attribute key
         * @type String
         */
        key : {
            value : null
        },
        /**
         * The type of this branch.
         * @attribute type
         * @type Int
         */
        type : {
            value : null,
            setter : function(value) {
                return parseInt(value, 10);
            }
        },
        /**
         * The link to use for this branch.
         * @attribute link
         * @type String
         */
        link : {
            value : false
        },
        /**
         * The Icon to add when displaying this branch.
         * @attribute icon
         * @type Object
         */
        icon : {
            value : false,
            validator : Y.Lang.isObject
        },
        /**
         * True if this branch is expandable.
         * @attribute expandable
         * @type Boolean
         */
        expandable : {
            value : false,
            validator : Y.Lang.isBool
        },
        /**
         * True if this branch is hidden and should be displayed greyed out.
         * @attribute hidden
         * @type Boolean
         */
        hidden : {
            value : false,
            validator : Y.Lang.isBool
        },
        /**
         * True if this branch has any children.
         * @attribute haschildren
         * @type Boolean
         */
        haschildren : {
            value : false,
            validator : Y.Lang.isBool
        },
        /**
         * An array of other branches that appear as children of this branch.
         * @attribute children
         * @type Array
         */
        children : {
            value : [],
            validator : Y.Lang.isArray
        }
    }
});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
